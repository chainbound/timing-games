
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Bid Value Increases per 200ms Bucket</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 20px;
      margin: 0 auto;
      font-size: 12px;
    }
    h1 {
      margin-bottom: 5px;
      font-size: 18px;
    }
    h2 {
      margin-top: 0;
      color: #666;
      font-weight: normal;
      font-size: 14px;
    }
    .range-controls {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .range-row {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    .range-row label {
      min-width: 70px;
      font-weight: 500;
      font-size: 11px;
    }
    .range-row input[type="range"] {
      flex: 1;
      min-width: 200px;
    }
    .range-row .value {
      min-width: 60px;
      font-family: monospace;
      font-size: 11px;
    }
    .range-info {
      margin-top: 10px;
      padding: 6px;
      background: white;
      border-radius: 4px;
      font-size: 11px;
    }
    .scroll-container {
      overflow-x: auto;
      overflow-y: hidden;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      background: #fafafa;
    }
    .plots-wrapper {
      min-width: 1400px;
    }
    .plot-container {
      margin-bottom: 20px;
    }
    /* Enhanced tooltip styling */
    [aria-label][role="img"] {
      background: white !important;
      border: 2px solid #333 !important;
      border-radius: 6px !important;
      padding: 12px !important;
      font-size: 14px !important;
      font-weight: 500 !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
      pointer-events: none !important;
      white-space: pre !important;
      line-height: 1.6 !important;
    }
    /* Highlight bars on hover */
    rect:hover {
      opacity: 1 !important;
      filter: brightness(1.1);
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Bid Value Increases per 200ms Bucket</h1>
  <h2>Blocks 24341606 - 24391605 (50000 blocks)</h2>

  <div class="range-controls">
    <div class="range-row">
      <label for="min-range">Min Time:</label>
      <input type="range" id="min-range" min="undefined" max="undefined" value="undefined" step="200">
      <span class="value" id="min-value">undefinedms</span>
    </div>
    <div class="range-row">
      <label for="max-range">Max Time:</label>
      <input type="range" id="max-range" min="undefined" max="undefined" value="undefined" step="200">
      <span class="value" id="max-value">undefinedms</span>
    </div>
    <div class="range-info">
      Showing <strong><span id="range-display">undefinedms - undefinedms</span></strong>
      (<span id="point-count">0</span> data points)
      &nbsp;|&nbsp;
      <strong>Weighted mean increase:</strong> <span id="weighted-mean">0.000000000</span> ETH
    </div>
  </div>

  <div class="scroll-container">
    <div class="plots-wrapper" id="plots-container">
      <div class="plot-container"><figure class="plot-d6a7b5-figure" style="max-width: initial;"><h2>MEAN</h2><svg class="plot-d6a7b5" fill="currentColor" font-family="system-ui, sans-serif" font-size="10" text-anchor="middle" width="1400" height="150" viewBox="0 0 1400 150"><style>:where(.plot-d6a7b5) {
  --plot-background: white;
  display: block;
  height: auto;
  height: intrinsic;
  max-width: 100%;
}
:where(.plot-d6a7b5 text),
:where(.plot-d6a7b5 tspan) {
  white-space: pre;
}</style><g aria-label="y-grid" aria-hidden="true" stroke="currentColor" stroke-opacity="0.1"><line x1="80" x2="1380" y1="65" y2="65"></line></g><g aria-label="y-axis tick" aria-hidden="true" fill="none" stroke="currentColor"><path transform="translate(80,65)" d="M0,0L-6,0"></path></g><g aria-label="y-axis tick label" text-anchor="end" font-variant="tabular-nums" transform="translate(-9,0)"><text y="0.32em" transform="translate(80,65)">0.000000</text></g><g aria-label="y-axis label" text-anchor="start" transform="translate(-77,-27)"><text y="0.71em" transform="translate(80,30)">ETH</text></g><g aria-label="rule" stroke="currentColor"><line x1="80" x2="1380" y1="65" y2="65"></line></g></svg></figure></div>
<div class="plot-container"><figure class="plot-d6a7b5-figure" style="max-width: initial;"><h2>P50</h2><svg class="plot-d6a7b5" fill="currentColor" font-family="system-ui, sans-serif" font-size="10" text-anchor="middle" width="1400" height="150" viewBox="0 0 1400 150"><style>:where(.plot-d6a7b5) {
  --plot-background: white;
  display: block;
  height: auto;
  height: intrinsic;
  max-width: 100%;
}
:where(.plot-d6a7b5 text),
:where(.plot-d6a7b5 tspan) {
  white-space: pre;
}</style><g aria-label="y-grid" aria-hidden="true" stroke="currentColor" stroke-opacity="0.1"><line x1="80" x2="1380" y1="65" y2="65"></line></g><g aria-label="y-axis tick" aria-hidden="true" fill="none" stroke="currentColor"><path transform="translate(80,65)" d="M0,0L-6,0"></path></g><g aria-label="y-axis tick label" text-anchor="end" font-variant="tabular-nums" transform="translate(-9,0)"><text y="0.32em" transform="translate(80,65)">0.000000</text></g><g aria-label="y-axis label" text-anchor="start" transform="translate(-77,-27)"><text y="0.71em" transform="translate(80,30)">ETH</text></g><g aria-label="rule" stroke="currentColor"><line x1="80" x2="1380" y1="65" y2="65"></line></g></svg></figure></div>
<div class="plot-container"><figure class="plot-d6a7b5-figure" style="max-width: initial;"><h2>P95</h2><svg class="plot-d6a7b5" fill="currentColor" font-family="system-ui, sans-serif" font-size="10" text-anchor="middle" width="1400" height="150" viewBox="0 0 1400 150"><style>:where(.plot-d6a7b5) {
  --plot-background: white;
  display: block;
  height: auto;
  height: intrinsic;
  max-width: 100%;
}
:where(.plot-d6a7b5 text),
:where(.plot-d6a7b5 tspan) {
  white-space: pre;
}</style><g aria-label="y-grid" aria-hidden="true" stroke="currentColor" stroke-opacity="0.1"><line x1="80" x2="1380" y1="65" y2="65"></line></g><g aria-label="y-axis tick" aria-hidden="true" fill="none" stroke="currentColor"><path transform="translate(80,65)" d="M0,0L-6,0"></path></g><g aria-label="y-axis tick label" text-anchor="end" font-variant="tabular-nums" transform="translate(-9,0)"><text y="0.32em" transform="translate(80,65)">0.000000</text></g><g aria-label="y-axis label" text-anchor="start" transform="translate(-77,-27)"><text y="0.71em" transform="translate(80,30)">ETH</text></g><g aria-label="rule" stroke="currentColor"><line x1="80" x2="1380" y1="65" y2="65"></line></g></svg></figure></div>
<div class="plot-container"><figure class="plot-d6a7b5-figure" style="max-width: initial;"><h2>P99</h2><svg class="plot-d6a7b5" fill="currentColor" font-family="system-ui, sans-serif" font-size="10" text-anchor="middle" width="1400" height="150" viewBox="0 0 1400 150"><style>:where(.plot-d6a7b5) {
  --plot-background: white;
  display: block;
  height: auto;
  height: intrinsic;
  max-width: 100%;
}
:where(.plot-d6a7b5 text),
:where(.plot-d6a7b5 tspan) {
  white-space: pre;
}</style><g aria-label="y-grid" aria-hidden="true" stroke="currentColor" stroke-opacity="0.1"><line x1="80" x2="1380" y1="65" y2="65"></line></g><g aria-label="y-axis tick" aria-hidden="true" fill="none" stroke="currentColor"><path transform="translate(80,65)" d="M0,0L-6,0"></path></g><g aria-label="y-axis tick label" text-anchor="end" font-variant="tabular-nums" transform="translate(-9,0)"><text y="0.32em" transform="translate(80,65)">0.000000</text></g><g aria-label="y-axis label" text-anchor="start" transform="translate(-77,-27)"><text y="0.71em" transform="translate(80,30)">ETH</text></g><g aria-label="rule" stroke="currentColor"><line x1="80" x2="1380" y1="65" y2="65"></line></g></svg></figure></div>
<div class="plot-container"><figure class="plot-d6a7b5-figure" style="max-width: initial;"><h2>MAX</h2><svg class="plot-d6a7b5" fill="currentColor" font-family="system-ui, sans-serif" font-size="10" text-anchor="middle" width="1400" height="150" viewBox="0 0 1400 150"><style>:where(.plot-d6a7b5) {
  --plot-background: white;
  display: block;
  height: auto;
  height: intrinsic;
  max-width: 100%;
}
:where(.plot-d6a7b5 text),
:where(.plot-d6a7b5 tspan) {
  white-space: pre;
}</style><g aria-label="y-grid" aria-hidden="true" stroke="currentColor" stroke-opacity="0.1"><line x1="80" x2="1380" y1="60" y2="60"></line></g><g aria-label="y-axis tick" aria-hidden="true" fill="none" stroke="currentColor"><path transform="translate(80,60)" d="M0,0L-6,0"></path></g><g aria-label="y-axis tick label" text-anchor="end" font-variant="tabular-nums" transform="translate(-9,0)"><text y="0.32em" transform="translate(80,60)">0.000000</text></g><g aria-label="y-axis label" text-anchor="start" transform="translate(-77,-27)"><text y="0.71em" transform="translate(80,30)">ETH</text></g><g aria-label="x-axis label" transform="translate(0,57)"><text transform="translate(730,90)">Time bucket (ms from slot start)</text></g><g aria-label="rule" stroke="currentColor"><line x1="80" x2="1380" y1="60" y2="60"></line></g></svg></figure></div>
    </div>
  </div>

  <script>
    // Embedded data
    const fullData = [];
    const bucketSize = 200;
    const maxBlocks = undefined;

    const metrics = [
      { name: "mean", field: "mean_increase_eth", color: "#4e79a7" },
      { name: "p50", field: "p50_increase_eth", color: "#f28e2c" },
      { name: "p95", field: "p95_increase_eth", color: "#e15759" },
      { name: "p99", field: "p99_increase_eth", color: "#76b7b2" },
      { name: "max", field: "max_increase_eth", color: "#59a14f" },
    ];

    const minRange = document.getElementById('min-range');
    const maxRange = document.getElementById('max-range');
    const minValue = document.getElementById('min-value');
    const maxValue = document.getElementById('max-value');
    const rangeDisplay = document.getElementById('range-display');
    const pointCount = document.getElementById('point-count');
    const plotsContainer = document.getElementById('plots-container');
    const weightedMeanEl = document.getElementById('weighted-mean');

    function updatePlots() {
      const min = parseInt(minRange.value);
      const max = parseInt(maxRange.value);

      // Ensure min <= max
      if (min > max) {
        if (this === minRange) {
          maxRange.value = min;
        } else {
          minRange.value = max;
        }
        return updatePlots.call(this);
      }

      // Update display values
      minValue.textContent = min + 'ms';
      maxValue.textContent = max + 'ms';
      rangeDisplay.textContent = `${min}ms - ${max}ms`;

      // Filter data
      const filteredData = fullData.filter(d => d.ms_bucket >= min && d.ms_bucket <= max);
      pointCount.textContent = filteredData.length;

      // Calculate weighted mean increase across selected range
      const totalBlocks = filteredData.reduce((sum, d) => sum + d.num_blocks, 0);
      const weightedSum = filteredData.reduce((sum, d) => sum + d.mean_increase_eth * d.num_blocks, 0);
      const weightedMean = totalBlocks > 0 ? weightedSum / totalBlocks : 0;
      weightedMeanEl.textContent = weightedMean.toFixed(9);

      // Calculate dynamic width
      const plotWidth = Math.max(1400, filteredData.length * 40);

      // Generate new plots
      const plots = metrics.slice(0, -1).map((metric) => {
        const metricData = filteredData.map((d) => ({
          ms_bucket: d.ms_bucket,
          value: d[metric.field],
          num_blocks: d.num_blocks,
        }));

        return Plot.plot({
          title: metric.name.toUpperCase(),
          width: plotWidth,
          height: 150,
          marginLeft: 80,
          marginBottom: 50,
          marginTop: 30,
          x: {
            label: null,
            tickFormat: (d) => `${d}ms`,
          },
          y: {
            label: "ETH",
            grid: true,
          },
          marks: [
            Plot.barY(metricData, {
              x: "ms_bucket",
              y: "value",
              fill: metric.color,
              opacity: (d) => 0.5 + 0.5 * (d.num_blocks / maxBlocks),
              title: (d) =>
                `Bucket: ${d.ms_bucket}ms - ${d.ms_bucket + bucketSize}ms\n${metric.name}: ${d.value.toFixed(9)} ETH\nBlocks: ${d.num_blocks}`,
            }),
            Plot.ruleY([0]),
            Plot.text(metricData, {
              x: "ms_bucket",
              y: "value",
              text: (d) => d.value.toFixed(6),
              dy: -5,
              fontSize: 7,
              fill: "#333",
              fontWeight: "bold",
            }),
            Plot.text(metricData, {
              x: "ms_bucket",
              y: 0,
              text: (d) => d.num_blocks,
              dy: 25,
              fontSize: 7,
              fill: "#999",
            }),
          ],
        });
      });

      // Add last plot with x-axis label
      const maxMetric = metrics[metrics.length - 1];
      const maxData = filteredData.map((d) => ({
        ms_bucket: d.ms_bucket,
        value: d[maxMetric.field],
        num_blocks: d.num_blocks,
      }));

      const lastPlot = Plot.plot({
        title: "MAX",
        width: plotWidth,
        height: 150,
        marginLeft: 80,
        marginBottom: 60,
        marginTop: 30,
        x: {
          label: "Time bucket (ms from slot start)",
          tickFormat: (d) => `${d}ms`,
        },
        y: {
          label: "ETH",
          grid: true,
        },
        marks: [
          Plot.barY(maxData, {
            x: "ms_bucket",
            y: "value",
            fill: maxMetric.color,
            opacity: (d) => 0.5 + 0.5 * (d.num_blocks / maxBlocks),
            title: (d) =>
              `Bucket: ${d.ms_bucket}ms - ${d.ms_bucket + bucketSize}ms\nmax: ${d.value.toFixed(9)} ETH\nBlocks: ${d.num_blocks}`,
          }),
          Plot.ruleY([0]),
          Plot.text(maxData, {
            x: "ms_bucket",
            y: "value",
            text: (d) => d.value.toFixed(6),
            dy: -5,
            fontSize: 7,
            fill: "#333",
            fontWeight: "bold",
          }),
          Plot.text(maxData, {
            x: "ms_bucket",
            y: 0,
            text: (d) => d.num_blocks,
            dy: 35,
            fontSize: 7,
            fill: "#999",
          }),
        ],
      });

      plots.push(lastPlot);

      // Update plots container
      plotsContainer.innerHTML = plots.map(plot => `<div class="plot-container">${plot.outerHTML}</div>`).join('\n');

      // Update wrapper width
      document.querySelector('.plots-wrapper').style.minWidth = plotWidth + 'px';
    }

    // Add event listeners
    minRange.addEventListener('input', updatePlots);
    maxRange.addEventListener('input', updatePlots);
  </script>
</body>
</html>
